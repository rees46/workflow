name: Version composite action
description: patch versions of changed packages

inputs:
  private:
    description: Should apply only to private?
    required: false
    default: 'false'
  checkChanges:
    description: Should run 'yarn --since'?
    required: false
    default: 'true'
  token:
    description: GitHub PAT
    required: true

runs:
  using: composite

  steps:
    - name: List changed workspaces
      env:
        BASE_COMMIT: ${{ steps.find_base_commit.outputs.baseCommit }}
      run: yarn workspaces list --since=$BASE_COMMIT^
      shell: bash

    - name: Version
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
        IS_PRIVATE: ${{ inputs.private }}
        SHOULD_CHECK_CHANGES: ${{ inputs.checkChanges }}
      run: |
        if [ $IS_PRIVATE == 'false' ]; then
          PRIVATE_FLAG="--no-private"
        fi
        
        if [ $SHOULD_CHECK_CHANGES == 'true' ]; then
          CHANGES_FLAG="--since=${{ steps.find_base_commit.outputs.baseCommit }}^"
          else
          CHANGES_FLAG="--all"
        fi
        
        yarn workspaces foreach $CHANGES_FLAG $PRIVATE_FLAG --verbose version patch --immediate
      shell: bash
