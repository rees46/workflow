name: ios build
description: build ios package

inputs:
  workingDirectory:
    description: xcodebuild directory
    required: false
    default: ''
  infoPlistPath:
    description: Path to Info.plist to get application version
    required: false
    default: 'Info.plist'
  githubUsername:
    description: GitHub username for access to github-packages
    required: false
    default: ''
  githubToken:
    description: GitHub token for access to github-packages
    required: false
    default: ''
  archivePath:
    description: string
    required: true
  appStoreConnectApiKeyId:
    description: string
    required: true
  appStoreConnectIssuerId:
    description: string
    required: true
  xcworkspace:
    description: string
    required: true
  scheme:
    description: string
    required: true
  codeSignIdentity:
    description: string
    required: true
  developmentTeam:
    description: string
    required: true
  provisioningProfileSpecifier:
    description: string
    required: true

runs:
  using: composite
  steps:
    - name: Get versions
      id: get-version
      shell: bash
      run: |
        CURRENT_PROJECT_VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" "${{ github.workspace }}/${{ inputs.infoPlistPath }}")
        MARKETING_VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" "${{ github.workspace }}/${{ inputs.infoPlistPath }}")

        echo "Current project version: $CURRENT_PROJECT_VERSION"
        echo "Current marketing version: $MARKETING_VERSION"

        echo "currentProjectVersion=$CURRENT_PROJECT_VERSION" >> "$GITHUB_OUTPUT"
        echo "marketingVersion=$MARKETING_VERSION" >> "$GITHUB_OUTPUT"

    - name: Build and Archive
      shell: bash
      working-directory: ${{ inputs.workingDirectory | github.workspace }}
      env:
        API_KEY_ID: ${{ inputs.appStoreConnectApiKeyId }}
        ISSUER_ID: ${{ inputs.appStoreConnectIssuerId }}
        ARCHIVE_PATH: ${{ inputs.archivePath }}
        GITHUB_USERNAME: ${{ inputs.githubUsername }}
        GITHUB_TOKEN: ${{ inputs.githubToken }}
      run: |
        TEAM_ID_ENV=MYA32EHWN4 \
        BUNDLE_ID_ENV=com.rees46.loyalty-program \
        APP_NAME_ENV="REES46 Loyalty Program" \
        PROVISIONING_PROFILE_SPECIFIER_ENV="loyalty distribution" \
        xcodebuild \
          -project iosApp.xcodeproj \
          -scheme iosApp \
          -configuration Release \
          -sdk iphoneos \
          clean build

        # TODO uncomment
        # xcrun xcodebuild \
        #   -workspace "${{ inputs.xcworkspace }}" \
        #   -scheme "${{ inputs.scheme }}" \
        #   -configuration AppStoreDistribution \
        #   -sdk iphoneos \
        #   -parallelizeTargets \
        #   -showBuildTimingSummary \
        #   -disableAutomaticPackageResolution \
        #   -archivePath "$ARCHIVE_PATH" \
        #   archive \
        #   CODE_SIGN_STYLE=Manual \
        #   CURRENT_PROJECT_VERSION="${{ steps.get-version.outputs.currentProjectVersion }}" \
        #   MARKETING_VERSION="${{ steps.get-version.outputs.marketingVersion }}" \
        #   CODE_SIGN_IDENTITY="${{ inputs.codeSignIdentity }}" \
        #   DEVELOPMENT_TEAM="${{ inputs.developmentTeam }}" \
        #   PROVISIONING_PROFILE_SPECIFIER="${{ inputs.provisioningProfileSpecifier }}" \
        #   OTHER_CODE_SIGN_FLAGS="--deep"
