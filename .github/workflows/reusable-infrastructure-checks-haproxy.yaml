name: Reusable infrastructure checks HAProxy

on:
  workflow_call:

jobs:
  haproxy:
    name: HAProxy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install HAProxy
        run: |
          sudo apt-get update && sudo apt-get install -y haproxy

      - name: Validate HAProxy configs
        run: |
          exit_code=0
           while read -r conf; do
            printf "\n\n"
            echo "ðŸ”ŽðŸ”ŽðŸ”Ž Validating $conf ðŸ”ŽðŸ”ŽðŸ”Ž"

            if haproxy -c -f "$conf"; then
              echo "RESULT: âœ…âœ…âœ…"
            else
              echo "RESULT: â›”â›”â›”"
              exit_code=1
            fi
          done < <(find $GITHUB_WORKSPACE -type f -name 'haproxy.cfg')

          if [ "$exit_code" -eq 0 ]; then
            echo "âœ…âœ…âœ… All haproxy.cfg files are valid âœ…âœ…âœ…"
          else
            echo "â›”â›”â›” One or more configuration files are invalid â›”â›”â›”"
            exit 1
          fi
